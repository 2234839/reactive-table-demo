{"version":3,"file":"index.52349b9d.js","sources":["../../src/components/reactive-table/_index.ts?vue&type=script&src&lang.ts"],"sourcesContent":["import { computed, ComputedRef, defineComponent, nextTick, reactive, ref, watchEffect } from \"vue\";\r\ntype table = Td[][];\r\ntype row_i = number;\r\ntype col_i = number;\r\n\r\nexport default defineComponent({\r\n  setup() {\r\n    const table = reactive([\r\n      [new Td(\"1\"), new Td(\"sum(select([0,1]))\", true), new Td(\"sum(select([0,0])) + 42\", true)],\r\n      [new Td(\"2\"), new Td(\"2\"), new Td(\"2\")],\r\n      [\r\n        new Td(\"sumFilterNaN(select([0,0],[0,1],[0,2]))\", true),\r\n        new Td(\"sum(select([1,0],[1,1],[1,2]))\", true),\r\n        new Td(\"sumFilterNaN(select([2,0],[2,1]))\", true),\r\n      ],\r\n    ]);\r\n\r\n    /** ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêüè≥‚Äçüåà ‰∏ãÈù¢Ëøô‰∏™ÂùóÂÜÖÁöÑ‰ª£Á†ÅÊòØÊµãËØïÁî®ÁöÑ üè≥‚Äçüåà‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  */\r\n    {\r\n      function repeatCall(f: Function, i: number) {\r\n        if (i > 0) {\r\n          f();\r\n          repeatCall(f, i - 1);\r\n        } else {\r\n        }\r\n      }\r\n      repeatCall(addNewCol, 8);\r\n      repeatCall(addNewRow, 8);\r\n      /** ÊñêÊ≥¢ÈÇ£Â•ëÊï∞ÂàóÊµãËØï */\r\n      table[0].forEach((el, index) => {\r\n        if (index === 0) {\r\n        } else if (index === 1) {\r\n          el.isExp = true;\r\n          el.value = `sum(select([0,${index - 1}]))`;\r\n        } else {\r\n          el.isExp = true;\r\n          el.value = `sum(select([0,${index - 1}],[0,${index - 2}]))`;\r\n        }\r\n      });\r\n      // ~~ÁõÆÂâçÊòØÊ≤°Êúâ‰ºòÂåñÁöÑÔºåÂÜçÂæÄÂêéÁÆó‰∏ä‰∏ÄËΩÆÂ∞±ÂæàÊÖ¢‰∫Ü~~ ‰ΩøÁî®ÁºìÂ≠òÂêéÔºåËøô‰∏™ÈÄüÂ∫¶Â∑≤ÁªèÂèØ‰ª•Êé•Âèó‰∫Ü\r\n      table[1].forEach((el, index) => {\r\n        if (index === 0) {\r\n          el.isExp = true;\r\n          el.value = `sum(select([0,10]))`;\r\n        } else if (index === 1) {\r\n          el.isExp = true;\r\n          el.value = `sum(select([0,10],[1,${index - 1}]))`;\r\n        } else {\r\n          el.isExp = true;\r\n          el.value = `sum(select([1,${index - 1}],[1,${index - 2}]))`;\r\n        }\r\n      });\r\n      // Á≠âÊØîÊï∞ÂàóÊµãËØï\r\n      table[2].forEach((el, index) => {\r\n        if (index === 0) {\r\n        } else {\r\n          el.isExp = true;\r\n          el.value = `sum(select([2,${index - 1}])) * 2`;\r\n        }\r\n      });\r\n    }\r\n\r\n    function addNewCol() {\r\n      table.forEach((row) => row.push(new Td(\"1\")));\r\n    }\r\n    function addNewRow() {\r\n      const row = table[0].map(() => new Td(\"1\"));\r\n      table.push(row);\r\n    }\r\n    const selectTd = ref(new Td(\"\"));\r\n    /** ÂèØËÉΩÊòØË¢´ÂΩìÂâçÈÄâ‰∏≠ÁöÑ td ÊâÄ‰æùËµñÁöÑÂùó */\r\n    const mayBeAssociatedTd = computed(() => {\r\n      if (selectTd.value.isExp) {\r\n        return [...selectTd.value.value.matchAll(/\\[(\\d+),(\\d+)\\]/g)].map((el) => {\r\n          return table[Number(el[1])][Number(el[2])];\r\n        });\r\n      } else {\r\n        return [];\r\n      }\r\n    });\r\n    function select(td: Td) {\r\n      selectTd.value = td;\r\n    }\r\n    const editTd = ref(new Td(\"\"));\r\n    const editState = ref({\r\n      show: false,\r\n    });\r\n    function edit(td: Td) {\r\n      editTd.value = td;\r\n      editState.value.show = true;\r\n    }\r\n\r\n    /** ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêüè≥‚Äçüåà debug Êó•Âøó üè≥‚Äçüåà‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  */\r\n    const updateLog = ref([] as [string, number][]);\r\n    function addLog(p: string, t = performance.now()) {\r\n      updateLog.value.push([p, t]);\r\n    }\r\n    const updateLogView = computed(() => [...updateLog.value].reverse());\r\n    addLog(`// ${new Date().toLocaleString()} Á®ãÂ∫èÂêØÂä®`);\r\n    watchEffect(() => {\r\n      const length = updateLog.value.length;\r\n      nextTick(() => {\r\n        if (length === updateLog.value.length && !updateLog.value[length - 1][0].startsWith(\"//\")) {\r\n          const startLog_i = updateLogView.value.findIndex((el) => el[0].startsWith(\"//\")) - 1;\r\n          const elapsedTime = updateLog.value[length - 1][1] - updateLogView.value[startLog_i][1];\r\n          addLog(`// ${new Date().toLocaleString()} ËÆ°ÁÆóÂÆåÊØï,ËÄóÊó∂ ${elapsedTime}ms`);\r\n        }\r\n      });\r\n    });\r\n    /** ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêüè≥‚Äçüåà Êï∞ÊçÆË°®ÁöÑÂÆûÈôÖÂèØËßÜÈÉ®ÂàÜ üè≥‚Äçüåà‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  */\r\n    let updateTheOrder = 0;\r\n    /** ‰ªéÂéüÂßãÊï∞ÊçÆËÆ°ÁÆóÂá∫ÂÄºÁöÑÊñ∞Ë°® */\r\n    const computedTable = computed(() =>\r\n      table.map((row) =>\r\n        row.map((td) => {\r\n          // ÁªèÂ∞ùËØïÔºåÂçïÁ∫ØÁöÑ‰øÆÊîπ td ‰∏ç‰ºöÂàõÂª∫Êñ∞ÁöÑ computed Ôºå‰ΩÜ table Êñ∞Â¢ûÂÖÉÁ¥†‰ºöÂØºËá¥ÂàõÂª∫Âíå td Êï∞Èáè‰∏ÄÊ†∑Â§öÁöÑ computedÔºõ\r\n          // ‰ºòÂåñÁÇπÔºöÂ∫îËØ•‰øùÁïôÂéüÊúâÁöÑ computed\r\n          console.log(\"<new computed>\");\r\n\r\n          return computed(() => {\r\n            const value = evaluation(td, table);\r\n            updateTheOrder += 1;\r\n            addLog(`Á¨¨${updateTheOrder}Ê¨°ËÆ°ÁÆóÔºå[${Ê±ÇÂùêÊ†á(td, table)}] Â§ÑÁöÑÂÄº‰∏∫<${td.isExp ? \"exp\" : \"raw\"} ${value}>`);\r\n            return {\r\n              value,\r\n              /** value ÊòØÂì™‰∏ÄÊ¨°ËÆ°ÁÆóÂá∫Êù•ÁöÑ */\r\n              updateTheOrder,\r\n            };\r\n          });\r\n        }),\r\n      ),\r\n    );\r\n\r\n    return {\r\n      table,\r\n      computedTable,\r\n      updateLogView,\r\n      addNewRow,\r\n      addNewCol,\r\n      selectTd,\r\n      select,\r\n      editTd,\r\n      editState,\r\n      edit,\r\n      mayBeAssociatedTd,\r\n    };\r\n  },\r\n});\r\n\r\nclass Td {\r\n  constructor(\r\n    /** ÂÄº */\r\n    public value = \"\",\r\n    /** ÊòØÂê¶‰Ωú‰∏∫ÂáΩÊï∞ */\r\n    public isExp = false,\r\n    public cache = null,\r\n  ) {}\r\n}\r\n\r\n/** Ê±ÇÂÄºÂáΩÊï∞ÔºåÂ≠òÂú®ÈÄíÂΩíÁöÑÈóÆÈ¢ò */\r\nfunction evaluation(td: Td, table: table) {\r\n  try {\r\n    return evaluation1(td, []);\r\n  } catch (error) {\r\n    return String(error);\r\n  }\r\n  function evaluation1(td: Td, env: Td[]) {\r\n    if (env.includes(td)) {\r\n      throw `<ÂèëÁé∞[${Ê±ÇÂùêÊ†á(td, table)}]Â§ÑÂ≠òÂú®Âæ™ÁéØÂºïÁî®ÔºåÊó†Ê≥ïÊ±ÇÂÄº>`;\r\n    } else {\r\n      if (td.isExp) {\r\n        if (td.cache === null || env.length === 0) {\r\n          const r = inter(td.value);\r\n          td.cache = r;\r\n          return r;\r\n        } else {\r\n          return td.cache;\r\n        }\r\n      } else {\r\n        return td.value;\r\n      }\r\n    }\r\n\r\n    function inter(exp: string) {\r\n      console.log(\"<inter>\");\r\n\r\n      function select(...position: [row_i, col_i][]): Td[] {\r\n        return position.map((el) => table[el[0]][el[1]]);\r\n      }\r\n      function sum(ls: Td[]): number {\r\n        return ls.reduce((a, b) => {\r\n          return a + Number(evaluation1(b, [...env, td]));\r\n        }, 0);\r\n      }\r\n      /** ÂØπÂÄº‰∏∫ËΩ¨‰∏∫Êï∞ÂÄº‰πãÂêéÊòØ nan ÁöÑÂΩìÂÅö‰∏çÂ≠òÂú® */\r\n      function sumFilterNaN(ls: Td[]) {\r\n        return ls.reduce((a, b) => {\r\n          const r = Number(evaluation1(b, [...env, td]));\r\n          if (isNaN(r)) {\r\n            return a;\r\n          } else {\r\n            return a + r;\r\n          }\r\n        }, 0);\r\n      }\r\n      return eval(\r\n        exp,\r\n        //@ts-expect-error  ËøôÈáåÁî®‰∫é‰øùËØÅÁºñËØëÂêé select Ëøô‰∫õÂáΩÊï∞‰∏çË¢´Âà†Èô§Êéâ\r\n        [select, sum, sumFilterNaN],\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction Ê±ÇÂùêÊ†á(td: Td, table: table): [row_i, col_i] {\r\n  const row_i = table.findIndex((el) => el.includes(td));\r\n  return [row_i, table[row_i].findIndex((el) => el === td)];\r\n}\r\n"],"names":["defineComponent","[object Object]","table","reactive","Td","repeatCall","f","i","addNewCol","addNewRow","forEach","el","index","isExp","value","row","push","map","selectTd","ref","mayBeAssociatedTd","computed","matchAll","Number","editTd","editState","show","updateLog","p","t","performance","now","updateLogView","reverse","Date","toLocaleString","length","startsWith","startLog_i","findIndex","elapsedTime","updateTheOrder","computedTable","td","log","evaluation","Ê±ÇÂùêÊ†á","select","edit","cache","evaluation1","error","String","env","includes","r","inter","exp","position","ls","reduce","a","b","isNaN","eval","sum","sumFilterNaN","row_i"],"mappings":"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"}